FROM nvidia/cuda:12.4.0-devel-ubuntu22.04

ENV NVIDIA_VISIBLE_DEVICES ${NVIDIA_VISIBLE_DEVICES:-all}
ENV NVIDIA_DRIVER_CAPABILITIES ${NVIDIA_DRIVER_CAPABILITIES:+$NVIDIA_DRIVER_CAPABILITIES,}graphics,compute,utility,display

ENV DEBIAN_FRONTEND noninteractive
RUN echo "Acquire::GzipIndexes \"false\"; Acquire::CompressionTypes::Order:: \"gz\";" > /etc/apt/apt.conf.d/docker-gzip-indexes

RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
    less \
    emacs \
    tmux \
    bash-completion \
    software-properties-common \
    curl \
    wget \
    htop \
    git \
    build-essential \
    pkg-config \
    xdg-user-dirs \
    ca-certificates \
    libgl1-mesa-dev \
    libgl1-mesa-glx \
    libgl1-mesa-dri \
    freeglut3-dev \
    mesa-utils \
    mesa-utils-extra \
    vim \
    vulkan-tools \
    libvulkan-dev \
    libglfw3-dev \
    libegl1-mesa-dev \
    libglm-dev \
    libx11-dev \
    libomp-dev \
    libsm6 \
    libxext6 \
    libvulkan1 \
    vulkan-tools \
    libglvnd-dev \
    libglu1-mesa-dev \
    libxrender-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    bzip2 \
    gzip \
    zip \
    unzip \
    zstd \
    gcc \
    jq \
    make \
    libxrandr-dev \
    libxinerama-dev \
    libxcursor-dev \
    libxi-dev \
    xorg-dev \
    libglu1-mesa-dev \
    xvfb \
    xorg-dev \
    dbus-x11 \
    x11-utils \
    x11-xserver-utils \
    xserver-xephyr \
    ffmpeg \
    libjpeg-dev \
    libavformat-dev \
    libavcodec-dev \
    libavdevice-dev \
    libavutil-dev \
    libswscale-dev \
    libswresample-dev \
    libavfilter-dev \
    iproute2 \
    net-tools && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*


RUN mkdir -p /usr/share/vulkan/icd.d/ && \
    echo '{ "file_format_version" : "1.0.0", "ICD": { "library_path": "libGLX_nvidia.so.0", "api_version" : "1.3.205" } }' > /usr/share/vulkan/icd.d/nvidia_icd.json

RUN mkdir -p /usr/share/glvnd/egl_vendor.d/ && \
    echo '{"file_format_version" : "1.0.0", "ICD" : { "library_path" : "libEGL_nvidia.so.0" }}' > /usr/share/glvnd/egl_vendor.d/10_nvidia.json

ARG XDG_RUNTIME_DIR="/tmp/xdg_runtime_dir"
RUN mkdir -p ${XDG_RUNTIME_DIR} && chmod 777 ${XDG_RUNTIME_DIR}
ENV XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}


RUN mkdir -p /opt/conda && mkdir -p /workspace && mkdir -p /app

WORKDIR /app/

# Miniconda install
RUN wget -O /tmp/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-py39_25.9.1-3-Linux-x86_64.sh && \
    chmod +x /tmp/miniconda.sh
RUN bash /tmp/miniconda.sh -b -u -p /opt/conda && \
    rm /tmp/miniconda.sh
ENV PATH "/opt/conda/bin:/app:$PATH"
RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
RUN conda update -n base -c defaults conda -y && \
    conda clean -afy

ENV PATH "/usr/local/cuda/bin:${PATH}"
ENV LD_LIBRARY_PATH "/usr/local/cuda/lib64:/app:${LD_LIBRARY_PATH}"
ENV CUDA_HOME "/usr/local/cuda"

# Install cmake using conada
RUN conda install -y -c conda-forge cmake

# upgrade pip
RUN pip install --upgrade pip
RUN pip install --no-cache-dir numpy==1.24.4 numpy-quaternion==2023.0.4
RUN pip install --no-cache-dir ninja packaging fvcore iopath

# Install torch
# NOTE: torch version should be <= 2.4.1 for pytorch3d
RUN pip install --no-cache-dir torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cu124
RUN pip install --no-cache-dir transformers accelerate qwen-vl-utils[decord]

# Install habitat
RUN conda install habitat-sim==0.2.4 headless -c conda-forge -c aihabitat

WORKDIR /app
RUN git clone --branch v0.2.4 https://github.com/facebookresearch/habitat-lab.git
WORKDIR /app/habitat-lab
RUN pip install --no-cache-dir -e habitat-lab && \
    pip install --no-cache-dir -e habitat-baselines

# Install PyTorch3D
WORKDIR /app
RUN git clone https://github.com/facebookresearch/pytorch3d.git
WORKDIR /app/pytorch3d
ENV FORCE_CUDA=1
ENV TORCH_CUDA_ARCH_LIST="8.0 8.6 8.9 9.0"
RUN pip install --no-cache-dir -e . --no-build-isolation

WORKDIR /app

# Install CLIP
RUN pip install --no-cache-dir git+https://github.com/openai/CLIP.git

# Install EAI-VC
WORKDIR /app
RUN git clone https://github.com/facebookresearch/eai-vc.git
WORKDIR /app/eai-vc
RUN pip install --no-cache-dir -e vc_models/

WORKDIR /app

# Install other python packages
RUN pip install --no-cache-dir Pillow scipy==1.12.0 opencv-python==4.8.0.74 pynput termcolor pytest pytest-cov tqdm
RUN pip install --no-cache-dir pygame h5py lxml hidapi psutil scikit-image==0.22 moviepy==1.0.3 flask open3d timm scikit-learn==1.2.2
RUN pip install --no-cache-dir pyyaml ipython mkl mkl-include matplotlib==3.7.3 seaborn imageio
RUN pip install --no-cache-dir colorama==0.4.6 datasets==3.6.0 groq==0.9.0 ipykernel ipython gym==0.23.0 open3d PyYAML regex retrying typing_extensions
RUN pip install --no-cache-dir pyvirtualdisplay ftfy GPUtil trimesh openai einops
RUN pip install --no-cache-dir numpy==1.24.4 numba==0.57.1 numpy-quaternion==2023.0.4
RUN pip install --no-cache-dir sentence_transformers

RUN pip install --no-cache-dir Cython==0.29.36

# ARG USER_ID_LSJ=1002
# ARG GROUP_ID_LSJ=1002
# RUN addgroup --gid $GROUP_ID_LSJ lsj && \
#     adduser --home /home/lsj --disabled-password --gecos '' --uid $USER_ID_LSJ --gid $GROUP_ID_LSJ lsj
# RUN echo "lsj ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/lsj

# RUN chown -R lsj:lsj /app /tmp/xdg_runtime_dir && \
#     chmod -R 755 /app

# USER lsj

WORKDIR /app
CMD ["/bin/bash"]

# docker build -t lsj_habitat_base:0.2.4 -f habitat_024_cuda124_torch2_4_base . 
